<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>Administrator View</title>
        <meta name="viewport" content="initial-scale=1">
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <link href="css/styles.css" rel="stylesheet">

        <style>
            .node {
                cursor: move;
            }

            .node text {
                pointer-events: none;
                font: 12px sans-serif;
            }

            .cursor {
                fill: none;
                stroke: brown;
                pointer-events: none;
            }

            .link {
                stroke: #999;
                stroke-width: 1.5px;
            }
        </style>
    </head>
    <body>
        <script>
            var width = document.documentElement.clientWidth;
            var height = document.documentElement.clientHeight;
            var canvasWidth = width * 2;
            var canvasHeight = height * 2;

//            What is this used for?
            var fill = d3.scale.category20();

            var force = d3.layout.force()
                    .size([width, height])
                    .charge(-400)
                    .gravity(.05)
                    .distance(150)
                    .on("tick", tick);

            var drag = force.drag()
                    .on("dragstart", dragstart);

            var svg = d3.select("body").append("svg")
                    .attr("width", canvasWidth)
                    .attr("height", canvasHeight)
                    .on("mousemove", mousemove)
                    .on("mousedown", mousedown);

            var nodes = force.nodes(),
                    links = force.links(),
                    node = svg.selectAll(".node"),
                    link = svg.selectAll(".link");

            var cursor = svg.append("circle")
                    .attr("r", 30)
                    .attr("class", "cursor");

            d3.json("data/graph.json", function(error, json) {
                var jsonNodes = [];
                var jsonLinks = [];
                var query = "schemas.ogf.org";
                for (var obj in json) {
                    query = "schemas.ogf.org";
                    var add = false;
                    for (var key in json[obj]) {
                        if (key.indexOf(query) > -1) {
                            add = true;
                        }
                    }
                    if (add) {
                        console.log("Adding: " + obj);
                        var addedNode = jsonNodes.push({name: obj});
                        query = "isAlias";
                        for (var key in json[obj]) {
                            if (key.indexOf(query) > -1) {
                                for (var n in nodes) {
                                    if (n.name === json[obj][key]) {
                                        console.log("Found link to " + json[obj][key]);
                                        jsonLinks.push({source: addedNode, target: n});
                                    }
                                }
                            }
                        }
                    }
                }

                console.log(jsonNodes);

                force
                        .nodes(jsonNodes)
                        .links(jsonLinks)
                        .start();

                link = svg.selectAll(".link")
                        .data(jsonLinks)
                        .enter().append("line")
                        .attr("class", "link");

                node = svg.selectAll(".node")
                        .data(jsonNodes)
                        .enter().append("g") //or "circle"?
                        .attr("class", "node")
                        .on("dblclick", dblclick)
                        .call(drag);

                node.append("image")
                        .attr("xlink:href", "app.gif")
                        .attr("x", -8)
                        .attr("y", -8)
                        .attr("width", 16)
                        .attr("height", 16);

                node.append("text")
                        .attr("dx", 12)
                        .attr("dy", ".35em")
                        .text(function(d) {
                            return d.name
                        });

                force.on("tick", function() {
                    link.attr("x1", function(d) {
                        return d.source.x;
                    })
                            .attr("y1", function(d) {
                                return d.source.y;
                            })
                            .attr("x2", function(d) {
                                return d.target.x;
                            })
                            .attr("y2", function(d) {
                                return d.target.y;
                            });

                    node.attr("transform", function(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });
                });
            });

//            restart();

            function mousemove() {
                cursor.attr("transform", "translate(" + d3.mouse(this) + ")");
            }

            function mousedown() {
//                var point = d3.mouse(this),
//                        node = {x: point[0], y: point[1]},
//                n = nodes.push(node);

                // add links to any nearby nodes
//                nodes.forEach(function(target) {
//                    var x = target.x - node.x,
//                            y = target.y - node.y;
//                    if (Math.sqrt(x * x + y * y) < 30) {
//                        links.push({source: node, target: target});
//                    }
//                });
//
//                restart();
            }

            function dblclick(d) {
                d3.select(this).classed("fixed", d.fixed = false);
            }

            function dragstart(d) {
                d3.select(this).classed("fixed", d.fixed = true);
            }

            function tick() {
                link.attr("x1", function(d) {
                    return d.source.x;
                })
                        .attr("y1", function(d) {
                            return d.source.y;
                        })
                        .attr("x2", function(d) {
                            return d.target.x;
                        })
                        .attr("y2", function(d) {
                            return d.target.y;
                        });

                node.attr("cx", function(d) {
                    return d.x;
                })
                        .attr("cy", function(d) {
                            return d.y;
                        });
            }

            function restart() {
                link = link.data(links);

                link.enter().insert("line", ".node")
                        .attr("class", "link");

                node = node.data(nodes);

                node.enter().insert("circle", ".cursor")
                        .attr("class", "node")
                        .attr("r", 5)
                        .call(force.drag);

                force.start();
            }
        </script>
    </body>
</html>